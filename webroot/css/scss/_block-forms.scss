@use "queries" as *;

@layer blocks {
  form {
    display: grid;
    gap: var(--space-sm);
  }

  fieldset {
    border: 0;
    padding: 0;
    margin: 0;

    .input:nth-last-child(2),
    .input:last-child {
      margin-bottom: 0;
    }
  }

  legend {
    display: none;
  }

  label,
  .radios legend {
    display: block;
    max-width: max-content;
    font-weight: var(--font-weight-bold);
    font-size: var(--step--1);
    font-family: var(--font-serif);
    color: var(--color-ink-strong);
    margin-bottom: var(--space-2xs);
    padding: 0 var(--form-space-tight) 0;
    position: relative;
  }

  .radios legend {
    display: block;
  }

  label {
    input[type="radio"],
    input[type="checkbox"] {
      display: inline-block;
      margin: 0 0.25em;
    }
  }

  .checkbox,
  .radio {
    margin: 0 var(--form-space-tight);

    input,
    label {
      display: inline-block;
    }

    input {
      width: auto;
    }

    label {
      font-weight: var(--font-weight-regular);
      font-family: var(--font-sans);
    }
  }

  input,
  textarea,
  select {
    width: 100%;
    border: 1px solid var(--color-border-muted);
    background: var(--color-surface-muted);
    color: var(--color-ink-muted);
    border-radius: var(--radius-sm);
    min-height: 2.8rem;
    padding: 0.5rem 1.75rem 0.5rem 0.5rem;
    box-sizing: border-box;
    font-size: var(--step-0);
    transition: border 250ms ease-out, box-shadow 250ms ease-out;
  }

  optgroup {
    font-style: normal;
  }

  input[type="text"],
  input[type="password"],
  input[type="email"],
  input[type="url"],
  input[type="search"],
  input[type="tel"],
  input[type="week"],
  input[type="month"],
  textarea {
    width: 100%;
  }

  .input {
    margin: 0 0 var(--space-md);
  }

  option {
    padding: 0 var(--form-space-tight);
  }

  input[type="submit"],
  input[type="button"],
  input[type="checkbox"],
  input[type="radio"] {
    border: 0;
    padding: 0;
    width: auto;
  }

  input[type="color"] {
    height: 2.5em;
    width: 5em;
  }

  input[type="checkbox"],
  input[type="radio"] {
    accent-color: var(--color-brand-primary);
  }

  textarea {
    min-height: 8rem;
    resize: vertical;
  }

  .btn,
  button,
  input[type="submit"],
  input[type="button"],
  input[type="reset"] {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-height: 3.25rem;
    padding-inline: 1.75rem;
    border-radius: var(--radius-sm);
    border: 1px solid transparent;
    background: var(--color-brand-primary);
    color: var(--color-ink-on-dark);
    font-weight: var(--font-weight-bold);
    text-transform: uppercase;
    letter-spacing: 0.07em;
    font-size: var(--step--1);
    gap: 0.5rem;
    text-decoration: none;
    cursor: pointer;
    appearance: none;
  }

  .btn:visited {
    color: var(--color-ink-on-dark);
  }

  /* Link-buttons get the exact trailing icon from Pencil; form buttons stay text-only. */
  a.btn::after {
    content: "";
    display: inline-block;
    inline-size: 1.3em;
    block-size: 1.03em;
    flex: 0 0 auto;
    background-color: currentColor;
    -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 28.64 22.8'%3E%3Cpath d='M20.78 0l-3.5 0 6.64 9.68-23.92 0 0 3.44 23.97 0-6.72 9.68 3.51 0 7.88-11.33-7.86-11.47z'/%3E%3C/svg%3E");
    mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 28.64 22.8'%3E%3Cpath d='M20.78 0l-3.5 0 6.64 9.68-23.92 0 0 3.44 23.97 0-6.72 9.68 3.51 0 7.88-11.33-7.86-11.47z'/%3E%3C/svg%3E");
    -webkit-mask-repeat: no-repeat;
    mask-repeat: no-repeat;
    -webkit-mask-size: contain;
    mask-size: contain;
    -webkit-mask-position: center;
    mask-position: center;
    transform: translateY(0.02em);
  }

  .btn:hover,
  .btn:focus-visible,
  button:hover,
  button:focus-visible,
  input[type="button"]:hover,
  input[type="button"]:focus-visible,
  input[type="reset"]:hover,
  input[type="reset"]:focus-visible,
  input[type="submit"]:hover,
  input[type="submit"]:focus-visible {
    background: var(--color-brand-primary-hover);
  }

  .btn:active,
  button:active,
  input[type="submit"]:active {
    transform: translateY(1px);
  }

  .btn-sm {
    min-height: 2.8rem;
    padding-inline: 1rem;
    text-transform: none;
    letter-spacing: 0;
    font-size: var(--step-0);
    gap: 0;
  }

  /* Primary button — solid green, uppercase with arrow */
  .btn--primary {
    background: var(--color-brand-punch);
    color: var(--color-ink-on-dark);
    border-color: transparent;
  }

  .btn--primary:visited { color: var(--color-ink-on-dark); }

  .btn--primary:hover,
  .btn--primary:focus-visible {
    background: color-mix(in srgb, var(--color-brand-punch) 82%, var(--color-ink-absolute) 18%);
    color: var(--color-ink-on-dark);
  }

  /* Secondary button — outlined green */
  .btn--secondary {
    background: transparent;
    color: var(--color-brand-punch);
    border: 2px solid var(--color-brand-punch);
  }

  .btn--secondary:visited { color: var(--color-brand-punch); }

  .btn--secondary:hover,
  .btn--secondary:focus-visible {
    background: color-mix(in srgb, var(--color-brand-punch) 10%, transparent 90%);
    color: var(--color-brand-punch);
  }

  /* Outlined white button — for use on dark/navy backgrounds */
  .btn--outline-white {
    background: transparent;
    color: var(--color-ink-on-dark);
    border: 2px solid rgb(var(--white-rgb) / var(--alpha-60));
    padding-inline: 1.5rem;
    min-height: 2.75rem;
    text-transform: uppercase;
    letter-spacing: 0.07em;
    font-size: var(--step--1);
    font-weight: var(--font-weight-bold);
    display: inline-flex;
    align-items: center;
    gap: var(--space-2xs);
    text-decoration: none;
    border-radius: var(--radius-sm);
    transition: background 150ms, border-color 150ms;
  }

  .btn--outline-white:hover,
  .btn--outline-white:focus-visible {
    background: rgb(var(--white-rgb) / var(--alpha-10));
    border-color: var(--color-ink-on-dark);
  }

  .error-message {
    color: var(--color-state-critical);
    font-size: var(--step--1);
  }

  /* Search bar */
  .search-bar {
    padding: 0 0 var(--space-xl);

    .search-form-container {
      max-width: 40rem;
      margin: 0 auto;
    }

    form {
      display: flex;
      justify-content: flex-end;

      label {
        align-self: center;
      }
    }
  }

  .sitemap_search_input_header,
  .sitemap_search_input {
    border-radius: var(--radius-max) 0 0 var(--radius-max) !important;
    background-image: none !important;
    padding: 0.625rem 1.5rem !important;
    border-right: none;
    flex: 1;
    box-sizing: border-box;
    min-width: 0;
  }

  #CmsPluginIndexSearchForm {
    display: flex;
  }

  input[type="submit"].search-btn {
    padding-right: calc(2rem + 1em);
    background-image: url(/img/icons/magnifying-glass.svg);
    background-repeat: no-repeat;
    background-size: 1.5rem 1.5rem;
    background-position: calc(100% - 1em) 50% !important;
    border-radius: 0 var(--radius-max) var(--radius-max) 0;
  }

  /* Required / optional */
  legend,
  label,
  .form_tip {
    .required {
      color: color-mix(
        in srgb,
        var(--color-state-critical, #dc2626) 85%,
        var(--color-ink-on-dark, rgb(var(--white-rgb))) 15%
      );
    }
  }

  .optional {
    font-size: var(--step--1);
    font-style: italic;
    font-weight: var(--font-weight-regular);
    margin-left: var(--form-space-tight);
  }

  /* Login forms */
  #UserLoginForm,
  #UserRetrieveForm {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;

    .input.text,
    .input.password {
      flex: 0 0 auto;
      width: calc(50% - 0.9375rem);
      box-sizing: border-box;
      margin: 0 0 0.9375rem;
    }

    .submit {
      margin: 0;
    }
  }

  /* Client-side validation */
  form:invalid {
    input[type="submit"] {
      background: var(--color-border-muted);
      border: 0;
    }
  }

  :is(input, textarea):is(:invalid, :focus, :valid) {
    background-position: calc(100% - 0.375em) 0.55em;
    background-repeat: no-repeat;
    background-size: 1.125rem;
  }

  :is(input, textarea):invalid {
    background-image: url(/img/icons/circle-x.svg);
    border-color: var(--color-state-critical, #dc2626);
  }

  :is(input, textarea).invalid:not(:focus) {
    animation: shake-horizontal 1s cubic-bezier(0.455, 0.03, 0.515, 0.955) both !important;
  }

  @media (prefers-reduced-motion: reduce) {
    :is(input, textarea).invalid:not(:focus) {
      animation: none !important;
    }
  }

  :is(input, textarea):placeholder-shown {
    background-image: none;
    border-color: var(--color-border-muted);
  }

  :is(input, textarea):placeholder-shown:not(:focus) {
    animation: none;
  }

  input:hover,
  input:placeholder-shown:hover,
  textarea:hover,
  textarea:placeholder-shown:hover,
  select:hover {
    box-shadow: var(--shadow-sm);
  }

  :is(input, textarea):focus,
  :is(input, textarea).invalid:focus {
    background-image: url(/img/icons/circle-exclamation.svg);
    border-color: var(--color-focus-ring);
  }

  :is(input, textarea):valid,
  :is(input, textarea).invalid:valid {
    background-image: url(/img/icons/circle-check.svg);
    border-color: var(--color-state-success, #15803d);
  }

  :is(input, textarea).invalid {
    background-image: url(/img/icons/circle-x.svg);
    border-color: var(--color-state-critical, #dc2626);
  }

  :is(input, textarea):not(:required) {
    background-image: none;
    border-color: var(--color-border-muted);
  }

  @keyframes shake-horizontal {
    0%,
    100% {
      transform: translateX(0);
    }
    10%,
    30%,
    50%,
    70% {
      transform: translateX(-3px);
    }
    20%,
    40%,
    60% {
      transform: translateX(3px);
    }
    80% {
      transform: translateX(1px);
    }
    90% {
      transform: translateX(-1px);
    }
  }

  /* Tooltips and notes */
  .form_tip {
    display: inline-block;
    margin: 0.375rem 0 0.75rem;
    font-size: var(--step--1);
  }

  label {
    .tooltip {
      opacity: 0;
      transition: opacity 500ms ease-out;
    }

    &:hover {
      .tooltip {
        opacity: 1;
      }
    }
  }

  .tooltip {
    font-weight: var(--font-weight-regular);
    font-style: italic;
    font-size: var(--step--1);
    padding: var(--form-space-tight);
    border-radius: var(--radius-sm);
    background: rgb(var(--white-rgb) / var(--alpha-95));
    box-shadow: var(--shadow-sm);
    position: absolute;
    top: 50%;
    right: 0;
    transform: translate(100%, -50%);
    width: max-content;
  }

  .input-desc {
    font-size: var(--step--1);
    font-style: italic;
    padding: var(--form-space-tight) var(--form-space-tight) 0;
    display: block;
    color: var(--color-ink-meta);
  }

  @include vp-max($vp-md) {
    #UserLoginForm {
      .input.text,
      .input.password {
        width: 100%;
      }
    }
  }

  @include vp-max($vp-xs) {
    label {
      .tooltip {
        display: none;
      }
    }
  }
}
